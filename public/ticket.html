<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <title>Ticket Millionnaire</title>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      background: linear-gradient(orange, darkorange);
    }
    #ticket {
      position: relative;
      width: 800px;
      height: 500px;
      border: 4px solid #333;
      border-radius: 10px;
      overflow: hidden;
      text-align: center;
      background: white;
    }
    #logo {
      position: absolute;
      top: 10px;
      width: 100%;
      font-size: 40px;
      font-weight: bold;
      color: #0044cc;
      text-shadow: 2px 2px 4px white;
    }
    #ticketNumber {
      position: absolute;
      bottom: 10px;
      left: 15px;
      font-size: 20px;
      font-weight: bold;
      font-family: monospace;
      color: #333;
    }
    #canvas {
      position: absolute;
      top: 0; left: 0;
      width: 100%;
      height: 100%;
    }
    #alert {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%,-50%);
      background: white;
      border: 3px solid red;
      border-radius: 10px;
      padding: 30px;
      font-size: 24px;
      font-weight: bold;
      color: red;
      text-align: center;
      display: none;
      z-index: 1000;
    }
  </style>
</head>
<body>
  <div id="ticket">
    <div id="logo">Millionnaire</div>
    <div id="ticketNumber"></div>
    <canvas id="canvas"></canvas>
    <div id="alert">‚ö†Ô∏è Veuillez acheter un nouveau ticket</div>
  </div>

 <script>
  // --- R√©cup√©ration de l‚ÄôID depuis l‚ÄôURL ---
  const pathParts = window.location.pathname.split("/");
  const ticketId = pathParts[pathParts.length - 1]; // ex: /ticket/936 ‚Üí "936"

  const canvas = document.getElementById('canvas');
  const ctx = canvas.getContext('2d');
  canvas.width = canvas.offsetWidth;
  canvas.height = canvas.offsetHeight;

  const CX = canvas.width/2;
  const CY = canvas.height/2;
  const R  = 180;

  document.getElementById("ticketNumber").textContent = "N¬∞ " + ticketId;

  // V√©rifier si ticket d√©j√† gratt√©
  if (localStorage.getItem("usedTicket-" + ticketId)) {
    document.getElementById("alert").style.display = "block";
    canvas.style.display = "none";
  } else {
    // üîπ On r√©cup√®re les infos r√©elles du ticket via API
    fetch(`/checkTicket/${ticketId}`)
      .then(res => res.json())
      .then(ticket => {
        if (ticket.error) {
          alert("‚ùå Ticket introuvable !");
          return;
        }

        // Cr√©ation de la grille
        const symbols = [];
        if (ticket.gain !== "0") {
          for (let i = 0; i < 3; i++) symbols.push(ticket.gain);
        }
        const possibles = ["1K‚Ç¨","500‚Ç¨","100‚Ç¨","50‚Ç¨","10‚Ç¨","0"];
        while (symbols.length < 9) {
          const choice = possibles[Math.floor(Math.random()*possibles.length)];
          symbols.push(choice);
        }
        symbols.sort(() => Math.random()-0.5);

        // Dessin du ticket
        ctx.fillStyle = "#ccc";
        ctx.beginPath();
        ctx.arc(CX, CY, R, 0, Math.PI*2);
        ctx.fill();

        ctx.fillStyle = "black";
        ctx.font = "bold 24px Arial";
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";

        const cols = 3, rows = 3;
        const cellSize = (R*1.6) / cols;
        symbols.forEach((val, idx)=>{
          const r = Math.floor(idx/cols);
          const c = idx%cols;
          ctx.fillText(val, CX + (c-1)*cellSize, CY + (r-1)*cellSize);
        });

        const prizeImage = new Image();
        prizeImage.src = canvas.toDataURL();
        prizeImage.onload = () => {
          ctx.clearRect(0,0,canvas.width,canvas.height);
          ctx.fillStyle = "yellow";
          ctx.beginPath();
          ctx.arc(CX, CY, R, 0, Math.PI*2);
          ctx.fill();

          ctx.fillStyle = "black";
          ctx.font = "bold 30px Arial";
          ctx.textAlign = "center";
          ctx.fillText("GRATTER ICI", CX, CY);
        };

        // Gestion du grattage
        let scratching = false;
        function getPos(e){
          const rect = canvas.getBoundingClientRect();
          const x = (e.clientX || e.touches[0].clientX) - rect.left;
          const y = (e.clientY || e.touches[0].clientY) - rect.top;
          return {x,y};
        }
        function scratch(e){
          if(!scratching) return;
          const pos = getPos(e);
          const dist = Math.hypot(pos.x - CX, pos.y - CY);
          if(dist < R){
            ctx.globalCompositeOperation = "destination-out";
            ctx.beginPath();
            ctx.arc(pos.x, pos.y, 25, 0, Math.PI*2);
            ctx.fill();
            ctx.globalCompositeOperation = "source-over";
          }
        }
        canvas.addEventListener("mousedown", ()=> scratching = true);
        canvas.addEventListener("mouseup", ()=> {
          scratching = false;
          localStorage.setItem("usedTicket-" + ticketId, "true");
          setTimeout(()=> alert("‚è≥ Ce ticket va √™tre d√©truit !"), 500);
        });
        canvas.addEventListener("mousemove", scratch);
        canvas.addEventListener("touchstart", ()=> scratching = true);
        canvas.addEventListener("touchend", ()=> {
          scratching = false;
          localStorage.setItem("usedTicket-" + ticketId, "true");
          setTimeout(()=> alert("‚è≥ Ce ticket va √™tre d√©truit !"), 500);
        });
        canvas.addEventListener("touchmove", scratch);

        canvas.style.backgroundImage = `url(${prizeImage.src})`;
        canvas.style.backgroundRepeat = "no-repeat";
        canvas.style.backgroundPosition = "center";
        canvas.style.backgroundSize = "contain";
      })
      .catch(err => {
        console.error("Erreur API:", err);
        alert("‚ö†Ô∏è Impossible de charger le ticket !");
      });
  }
</script>

</body>
</html>
