<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>üé∞ Jackpot - GDJ</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Arial+Black&display=swap');

    body {
      margin: 0;
      background: #000;
      color: #fff;
      font-family: "Arial Black", sans-serif;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      overflow: hidden;
    }

    .container {
      display: flex;
      align-items: flex-start;
      justify-content: center;
      gap: 30px;
    }

    .ticket {
  position: relative;
  width: 520px;
  height: 720px;
  border-radius: 20px;
  background: radial-gradient(circle at center, #00ff66 0%, #002b0f 70%, #000 100%);
  box-shadow:
    0 0 35px #00ff66,
    0 0 70px #00ff66,
    inset 0 0 30px #00ff66;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: flex-start;
  padding-top: 100px;
  overflow: hidden;
}


    .logo-gdj {
      position: absolute;
      top: 20px;
      left: 20px;
      width: 70px;
    }

    .logo-jackpot {
      position: absolute;
      top: 25px;
      left: 50%;
      transform: translateX(-50%);
      width: 220px;
    }

    .price-circle {
      position: absolute;
      top: 25px;
      right: 25px;
      background: #fff;
      color: purple;
      font-size: 22px;
      font-weight: bold;
      border-radius: 50%;
      width: 70px;
      height: 70px;
      display: flex;
      justify-content: center;
      align-items: center;
      box-shadow: 0 0 10px #fff;
    }

    .machine-area {
      margin-top: 50px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      gap: 25px;
    }

    .machine {
      background: #111;
      border-radius: 15px;
      border: 3px solid #00ff66;
      box-shadow: 0 0 20px #00ff66;
      width: 320px;
      height: 130px;
      display: flex;
      flex-direction: row;
      justify-content: space-evenly;
      align-items: center;
      position: relative;
      overflow: hidden;
    }

    .symbol {
      font-size: 60px;
      text-shadow: 0 0 10px #00ff66;
    }

    canvas {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      cursor: pointer;
      border-radius: 15px;
    }

    .bottom-info {
      position: absolute;
      bottom: 15px;
      width: 100%;
      display: flex;
      justify-content: flex-start;
      padding-left: 45px;
    }

    .ticket-id {
      color: black;
      -webkit-text-stroke: 1px white;
      font-weight: bold;
    }

    .message {
      text-align: center;
      margin-top: 20px;
      font-size: 22px;
      color: #fff;
      text-shadow: 0 0 10px #00ff66;
    }

    .lot-table {
      background: #ffeb3b;
      color: #000;
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 0 20px #ffeb3b;
      font-weight: bold;
      width: 200px;
    }

    .lot-table h3 {
      text-align: center;
      margin-bottom: 10px;
      font-size: 22px;
    }

    .lot-table table {
      width: 100%;
      border-collapse: collapse;
    }

    .lot-table td {
      padding: 6px 0;
      text-align: center;
      font-size: 18px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="ticket" id="ticket">
      <img src="https://imgur.com/dk2AFfU.png" alt="GDJ" class="logo-gdj" />
      <img src="https://imgur.com/Vo8m5Fk.png" alt="JACKPOT" class="logo-jackpot" />
      <div class="price-circle">3 ‚Ç¨</div>

      <div class="machine-area" id="machines">
        <div class="machine">
          <div class="symbol" id="m1s1">?</div>
          <div class="symbol" id="m1s2">?</div>
          <div class="symbol" id="m1s3">?</div>
          <canvas></canvas>
        </div>
        <div class="machine">
          <div class="symbol" id="m2s1">?</div>
          <div class="symbol" id="m2s2">?</div>
          <div class="symbol" id="m2s3">?</div>
          <canvas></canvas>
        </div>
        <div class="machine">
          <div class="symbol" id="m3s1">?</div>
          <div class="symbol" id="m3s2">?</div>
          <div class="symbol" id="m3s3">?</div>
          <canvas></canvas>
        </div>
      </div>

      <div class="message" id="msg"></div>

      <div class="bottom-info">
        <div class="ticket-id" id="ticket-id">#0000</div>
      </div>
    </div>

    <div class="lot-table">
      <h3>Tableau des gains</h3>
      <table>
        <tr><td>üíéüíéüíé</td><td>30 000 ‚Ç¨</td></tr>
        <tr><td>üí∞üí∞üí∞</td><td>500 ‚Ç¨</td></tr>
        <tr><td>üëëüëëüëë</td><td>30 ‚Ç¨</td></tr>
        <tr><td>7Ô∏è‚É£7Ô∏è‚É£7Ô∏è‚É£</td><td>7 ‚Ç¨</td></tr>
        <tr><td>‚≠ê‚≠ê‚≠ê</td><td>3 ‚Ç¨</td></tr>
      </table>
    </div>
  </div>

  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const ticketId = urlParams.get("id");
    const code = urlParams.get("code");

    const apiURL = `/api/jackpot/ticket/${ticketId}?code=${code}`;
    const useURL = `/api/jackpot/use/${ticketId}`;
    const msg = document.getElementById("msg");

    async function loadTicket() {
      const res = await fetch(apiURL);
      const data = await res.json();

      // Si ticket d√©j√† utilis√©
      if (!res.ok || data.used) {
        document.querySelector(".ticket").innerHTML = `
          <h2 style='color:white;text-align:center;margin-top:250px'>
            üéüÔ∏è Ce ticket a d√©j√† √©t√© utilis√©<br><br>
            <a href='/api/buyJackpot' style='color:#00ff66;text-decoration:none'>
              Achetez un nouveau ticket
            </a>
          </h2>`;
        return;
      }

      document.getElementById("ticket-id").textContent = "#" + data.id;

      // Remplit les symboles
      data.machines.forEach((row, i) => {
        row.forEach((sym, j) => {
          document.getElementById(`m${i + 1}s${j + 1}`).textContent = sym;
        });
      });

      setupScratch(data);
    }

    function setupScratch(data) {
      const canvases = document.querySelectorAll(".machine canvas");
      let scratched = 0;
      let disabled = false;

      canvases.forEach((canvas) => {
        const ctx = canvas.getContext("2d");
        const w = canvas.width = canvas.offsetWidth;
        const h = canvas.height = canvas.offsetHeight;
        ctx.fillStyle = "#777";
        ctx.fillRect(0, 0, w, h);

        let isDrawing = false;
        const scratch = (x, y) => {
          if (disabled) return;
          ctx.globalCompositeOperation = "destination-out";
          ctx.beginPath();
          ctx.arc(x, y, 20, 0, Math.PI * 2);
          ctx.fill();
        };

        canvas.addEventListener("mousedown", () => (isDrawing = true));
        canvas.addEventListener("mouseup", () => {
          isDrawing = false;
          scratched++;
          if (scratched >= 3 && !disabled) {
            disabled = true;
            revealResult(data);
          }
        });
        canvas.addEventListener("mousemove", (e) => {
          if (!isDrawing || disabled) return;
          const rect = canvas.getBoundingClientRect();
          scratch(e.clientX - rect.left, e.clientY - rect.top);
        });
      });
    }

    async function revealResult(data) {
      msg.textContent =
        data.gain !== "0"
          ? `üéâ F√©licitations ! Vous gagnez ${data.gain.replace(/[^\d‚Ç¨]/g, "")} !`
          : "üò¢ Perdu, retentez votre chance !";

      // Marque comme utilis√© c√¥t√© serveur
      await fetch(useURL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ code })
      });

      // Bloque les interactions
      document.querySelectorAll("canvas").forEach(c => c.style.pointerEvents = "none");
    }

    loadTicket();
  </script>
</body>
</html>
