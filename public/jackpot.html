<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>üé∞ JACKPOT - GDJ</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Arial+Black&display=swap');

    body {
      margin: 0;
      background: #000;
      font-family: "Arial Black", sans-serif;
      overflow: hidden;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
    }

    .ticket {
      position: relative;
      width: 520px;
      height: 680px;
      border-radius: 20px;
      background: radial-gradient(circle at center, #00ff66 0%, #003311 80%);
      box-shadow: 0 0 25px #00ff66, inset 0 0 20px #00ff66;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      padding-top: 80px;
    }

    .logo-jackpot {
      position: absolute;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      width: 200px;
    }

    .logo-gdj {
      position: absolute;
      top: 25px;
      left: 25px;
      width: 60px;
    }

    .machine {
      display: flex;
      justify-content: center;
      align-items: center;
      margin-top: 80px;
      gap: 20px;
    }

    .reel {
      width: 110px;
      height: 140px;
      background: #222;
      border-radius: 15px;
      border: 3px solid #00ff66;
      box-shadow: 0 0 15px #00ff66;
      display: flex;
      justify-content: center;
      align-items: center;
      overflow: hidden;
      position: relative;
    }

    .symbol {
      font-size: 60px;
      color: #fff;
      text-shadow: 0 0 10px #00ff66;
    }

    canvas {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      border-radius: 15px;
      cursor: pointer;
    }

    .bottom-info {
      position: absolute;
      bottom: 15px;
      left: 0;
      width: 100%;
      padding: 0 25px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 18px;
      color: #fff;
      text-shadow: 0 0 3px #000;
    }

    .ticket-id {
      color: black;
      -webkit-text-stroke: 1px white;
    }

    .price {
      font-weight: bold;
    }

    .message {
      position: absolute;
      bottom: 80px;
      color: #fff;
      font-size: 20px;
      text-shadow: 0 0 10px #00ff66;
    }

    .disabled {
      pointer-events: none;
      opacity: 0.4;
    }
  </style>
</head>
<body>
  <div class="ticket" id="ticket-container">
    <img class="logo-gdj" src="https://imgur.com/dk2AFfU.png" alt="GDJ" />
    <img class="logo-jackpot" src="https://imgur.com/Vo8m5Fk.png" alt="Jackpot" />

    <div class="machine">
      <div class="reel"><div class="symbol" id="sym1">?</div><canvas></canvas></div>
      <div class="reel"><div class="symbol" id="sym2">?</div><canvas></canvas></div>
      <div class="reel"><div class="symbol" id="sym3">?</div><canvas></canvas></div>
    </div>

    <div class="message" id="msg"></div>

    <div class="bottom-info">
      <div class="ticket-id" id="ticket-id">#0000</div>
      <div class="price">üí∂ 3 ‚Ç¨</div>
    </div>
  </div>

  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const ticketId = urlParams.get("id");
    const code = urlParams.get("code");
    const apiURL = `/api/jackpot/${ticketId}?code=${code}`;
    const useURL = `/api/jackpot/use/${ticketId}`;
    const msg = document.getElementById("msg");

    async function loadTicket() {
      const res = await fetch(apiURL);
      const data = await res.json();
      if (!res.ok || data.used) {
        document.getElementById("ticket-container").innerHTML =
          "<h2 style='color:white;text-align:center'>üéüÔ∏è Ticket d√©j√† utilis√©<br><br><a href='/api/buyJackpot' style='color:#00ff66;text-decoration:none'>Achetez un nouveau ticket</a></h2>";
        return;
      }

      document.getElementById("ticket-id").textContent = "#" + data.id;

      const symbols = [data.reel1, data.reel2, data.reel3];
      ["sym1", "sym2", "sym3"].forEach((id, i) => {
        document.getElementById(id).textContent = symbols[i];
      });

      setupScratch(data);
    }

    function setupScratch(data) {
      const reels = document.querySelectorAll(".reel canvas");
      let scratched = 0;

      reels.forEach((canvas) => {
        const ctx = canvas.getContext("2d");
        const w = canvas.width = canvas.offsetWidth;
        const h = canvas.height = canvas.offsetHeight;

        ctx.fillStyle = "#777";
        ctx.fillRect(0, 0, w, h);

        let isDrawing = false;

        const scratch = (x, y) => {
          ctx.globalCompositeOperation = "destination-out";
          ctx.beginPath();
          ctx.arc(x, y, 20, 0, Math.PI * 2);
          ctx.fill();
        };

        canvas.addEventListener("mousedown", () => (isDrawing = true));
        canvas.addEventListener("mouseup", () => (isDrawing = false));
        canvas.addEventListener("mousemove", (e) => {
          if (!isDrawing) return;
          const rect = canvas.getBoundingClientRect();
          scratch(e.clientX - rect.left, e.clientY - rect.top);
        });

        canvas.addEventListener("touchmove", (e) => {
          e.preventDefault();
          const rect = canvas.getBoundingClientRect();
          const touch = e.touches[0];
          scratch(touch.clientX - rect.left, touch.clientY - rect.top);
        });

        canvas.addEventListener("mouseup", async () => {
          scratched++;
          if (scratched >= 3) {
            msg.textContent = data.gain > 0
              ? `üíé Vous gagnez ${data.gain} ‚Ç¨ !`
              : "üò¢ Perdu, retentez votre chance !";
            await fetch(useURL, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ code })
            });
            reels.forEach(c => c.classList.add("disabled"));
          }
        });
      });
    }

    loadTicket();
  </script>
</body>
</html>
